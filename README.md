# Rewards API

A Spring Boot REST API for calculating customer reward points, using an in-memory H2 database seeded from CSV files.

## Features
- Calculates reward points for customers based on their transactions
- Data is loaded from CSV files on startup (customers and transactions)
- Endpoints to view rewards, add transactions, get last 3 months' data, and query by customer/month
- H2 database with web console for easy inspection
- Comprehensive test coverage for all layers

## Getting Started

### Prerequisites
- Java 17 or later
- Maven

### Setup & Run
1. **Clone the repository**
2. **Start the application:**
   ```bash
   ./mvnw spring-boot:run
   ```
   The API will be available at `http://localhost:8080`.

### Database & Data Seeding
- The app uses an in-memory H2 database (`rewardsdb`).
- On startup, customer and transaction data are loaded from:
  - `src/main/resources/customers.csv` (columns: name)
  - `src/main/resources/transactions.csv` (columns: customer_id, amount, date)
- IDs are auto-generated by the database; do not include an `id` column in the CSVs.
- You can edit these CSV files to change the initial data.

#### H2 Console
- Access the H2 web console at: [http://localhost:8080/h2-console](http://localhost:8080/h2-console)
- JDBC URL: `jdbc:h2:mem:rewardsdb`
- User: `sa` (no password)

---

## API Usage & Testing

### Endpoints
- `GET /api/rewards` — Get all customer rewards
- `POST /api/transactions` — Add a transaction
- `GET /api/rewards/last-three-months` — Get last 3 months' rewards for all customers
- `GET /api/rewards/{customerId}/{yearMonth}` — Get rewards for a specific customer and month

### Example Data & Testing

#### 1. Get all customer rewards
**Request:**
```sh
curl -X GET http://localhost:8080/api/rewards
```
**Example Response:**
```json
[
  {
    "customerId": 1,
    "customerName": "John Doe",
    "monthlyRewards": {
      "2024-05": 120,
      "2024-06": 90
    },
    "totalRewards": 210
  },
  {
    "customerId": 2,
    "customerName": "Jane Smith",
    "monthlyRewards": {
      "2024-05": 75,
      "2024-06": 60
    },
    "totalRewards": 135
  }
]
```

#### 2. Add a transaction
**Request:**
```sh
curl -X POST http://localhost:8080/api/transactions \
  -H "Content-Type: application/json" \
  -d '{"customerId": 1, "amount": 120.50, "date": "2024-07-01"}'
```
**Example Request Body:**
```json
{
  "customerId": 1,
  "amount": 120.50,
  "date": "2024-07-01"
}
```
**Example Response:**
```json
{
  "id": 10,
  "customerId": 1,
  "amount": 120.50,
  "date": "2024-07-01"
}
```

#### 3. Get last 3 months' rewards for all customers
**Request:**
```sh
curl -X GET http://localhost:8080/api/rewards/last-three-months
```
**Example Response:**
```json
[
  {
    "customerId": 1,
    "customerName": "John Doe",
    "monthlyRewards": {
      "2024-05": 120,
      "2024-06": 90,
      "2024-07": 60
    },
    "totalRewards": 270
  }
]
```

#### 4. Get rewards for a specific customer and month
**Request:**
```sh
curl -X GET http://localhost:8080/api/rewards/1/2024-07
```
**Example Response:**
```json
{
  "customerId": 1,
  "customerName": "John Doe",
  "month": "2024-07",
  "rewards": 60
}
```

### Example: Using curl

**1. Get All Customer Rewards**
```bash
curl http://localhost:8080/api/rewards
```

**2. Add a Transaction**
```bash
curl -X POST http://localhost:8080/api/transactions \
  -H "Content-Type: application/json" \
  -d '{"customerId": 1, "amount": 120.00, "date": "2024-07-01"}'
```

**3. Get Last 3 Months' Rewards for All Customers**
```bash
curl http://localhost:8080/api/rewards/last-three-months
```

**4. Get Rewards for a Specific Customer and Month**
```bash
curl http://localhost:8080/api/rewards/1/2024-05
```

### Example: Using Postman
1. **Open Postman** and create a new request.
2. **Set the request type** (GET or POST) and enter the endpoint URL (e.g., `http://localhost:8080/api/rewards`).
3. For **POST** requests (like `/api/transactions`):
   - Go to the **Body** tab.
   - Select **raw** and choose **JSON** from the dropdown.
   - Enter the JSON payload, for example:
     ```json
     {
       "customerId": 1,
       "amount": 120.00,
       "date": "2024-07-01"
     }
     ```
4. For **GET** requests, just enter the URL and click **Send**.
5. **Check the response** in the lower panel for data or error messages.
6. **Test error handling** by sending invalid data (e.g., negative amount, missing fields, or a non-existent customer ID) and observe the error response and status code.

### Error Handling
- The API returns clear error messages and appropriate HTTP status codes (400, 404, 500, etc) for invalid input, missing data, or server errors.
- All exceptions are handled by a global exception handler.

---

## Reward Calculation Rules
- 2 points per dollar over $100
- 1 point per dollar between $50-$100
- 0 points under $50

## Customizing Data
- To change initial customers or transactions, edit the CSV files and restart the app.
- Example `customers.csv`:
  ```csv
  name
  John Doe
  Jane Smith
  Sunny
  Bunny
  ```
- Example `transactions.csv`:
  ```csv
  customer_id,amount,date
  1,120.00,2024-04-01
  2,75.00,2024-05-01
  3,200.00,2024-04-15
  4,50.00,2024-05-10
  ```

## Testing
- Unit and integration tests are provided for model, service, controller, exception, and repository layers.
- To run all tests:
  ```bash
  ./mvnw test
  ```
- Test files are located in `src/test/java/com/homework/rewards/api/`.

## Troubleshooting
- If you see errors about missing tables or columns, ensure your CSVs match the expected format and that you have not included an `id` column.
- If the H2 console does not show your data, make sure the app is running and you are using the correct JDBC URL.
- For build or test failures, check the logs for details about missing dependencies or misconfigured files.

## Notes
- The database is in-memory and resets on each restart.
- All business logic is in the service layer; the controller is thin.
- No DTOs or transformers are used; the API uses Map-based input/output for simplicity.
- For questions or issues, please contact the maintainer.

## API Testing Examples

You can use these examples to test the API with curl or Postman.

### 1. Get All Customer Rewards
**GET** `/api/rewards`  
`curl -X GET http://localhost:8080/api/rewards`
**Response:**
```json
{"1":{"name":"John Doe","monthly":{"2024-05":90,"2024-06":120},"total":210},"2":{"name":"Jane Smith","monthly":{"2024-05":75},"total":75}}
```

### 2. Add a Transaction
**POST** `/api/transactions`  
Request Body: `{ "customerId": 1, "amount": 120.00, "date": "2024-07-01" }`  
`curl -X POST http://localhost:8080/api/transactions -H "Content-Type: application/json" -d '{"customerId":1,"amount":120.00,"date":"2024-07-01"}'`
**Response:**
```json
{"message":"Transaction added successfully","transaction":{"id":5,"customerId":1,"customerName":"John Doe","amount":120.00,"date":"2024-07-01"},"pointsEarned":90,"pointsCalculation":"$20 over $100 = 20 × 2 = 40 points, $50-$100 = 50 points, Total = 90 points"}
```

### 3. Get Last 3 Months Rewards for All Customers
**GET** `/api/rewards/last-three-months`  
`curl -X GET http://localhost:8080/api/rewards/last-three-months`
**Response:**
```json
{"1":{"name":"John Doe","monthly":{"2024-05":90,"2024-06":120,"2024-07":90},"total":300}}
```

### 4. Get Rewards for a Specific Customer and Month
**GET** `/api/rewards/{customerId}/{yearMonth}`  
Example: `curl -X GET http://localhost:8080/api/rewards/1/2024-07`
**Response:**
```json
{"customerId":1,"customerName":"John Doe","yearMonth":"2024-07","points":90}
``` 